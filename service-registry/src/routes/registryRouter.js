const express = require('express');
const router = express.Router();
const ServiceRegistry = require('../services/serviceRegistry');

const serviceRegisrty = new ServiceRegistry();

router.route('/registry/:servicename/:serviceport').put(async (req, res, next) => {
    const {servicename, serviceport} = req.params;

    const serviceip = req.connection.remoteAddress.replace(/^.*:/, '');

    const serviceKey = serviceRegisrty.register(servicename, serviceip, serviceport);

    return res.json({result: serviceKey})
});

router.route('/unregister/:servicename/:serviceport').delete(async (req, res, next) => {
    const {servicename, serviceport} = req.params;

    const serviceip = req.connection.remoteAddress.replace(/^.*:/, '');

    const serviceKey = serviceRegisrty.unregister(servicename, serviceip, serviceport);

    return res.json({result: `Deleted ${serviceKey}`})
});


router.route('/find/:servicename').get(async (req, res, next) => {
    const {servicename } = req.params;
    const svc = serviceRegisrty.get(servicename);
    if(!svc) return res.status(404).json({result: "Service not found"});
    return res.json(svc);
});


module.exports = router;
  