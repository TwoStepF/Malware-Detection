from flask import Flask, jsonify, request
from file_checker import checkFile
import signal
import sys
import requests
def registerService():
    requests.put(f'http://localhost:3001/seviceRegistry/registry/ml-service/5000')

def unregisterService():
    requests.delete(f'http://localhost:3001/seviceRegistry/unregister/ml-service/5000')

        
app = Flask(__name__)
def handle_signal(signum, frame):
    unregisterService()
    sys.exit(0)

@app.route('/check_file', methods=['POST'])
def check_file():
    if 'file' not in request.files:
        return jsonify({'error': 'No file uploaded'}), 400

    uploaded_file = request.files['file']

    if uploaded_file.filename == '':
        return jsonify({'error': 'No file selected'}), 400

    legitimate = checkFile(uploaded_file)
    print(uploaded_file.filename)
    if legitimate:
        result = {'message': f"File {uploaded_file.filename} seems legitimate file!", 'bool': False}
    else:
        result = {'message': f"File {uploaded_file.filename} is probably a MALWARE!!!", 'bool': True}

    return jsonify(result)

if __name__ == '__main__':
    registerService()
    signal.signal(signal.SIGINT, handle_signal)
    signal.signal(signal.SIGTERM, handle_signal)

    app.run()